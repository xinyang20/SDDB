{% extends 'base.html' %}

{% block title %}任务分配{% endblock %}

{% block head %}
<script src="{{url_for('static',filename='js/assign_tasks.js')}}"></script>
<link rel="stylesheet" href="{{url_for('static',filename='css/assign_tasks.css')}}">
{% endblock %}

{% block body %}
<div class="container">
    <!-- 任务统计 - 使用卡片样式 -->
    <div class="metrics-grid"
        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px;">
        <div class="metric-card"
            style="background: #5397f4; border-radius: 12px; padding: 24px; color: white; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); transition: transform 0.3s ease;">
            <h3 style="font-size: 14px; font-weight: 500; margin: 0 0 12px 0; opacity: 0.9; color: white;">未完成订单</h3>
            <p class="metric-value" style="font-size: 36px; font-weight: 700; margin: 0; color: white;">{{
                stats.unfinished_orders }}</p>
        </div>
        <div class="metric-card"
            style="background: #5397f4; border-radius: 12px; padding: 24px; color: white; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); transition: transform 0.3s ease;">
            <h3 style="font-size: 14px; font-weight: 500; margin: 0 0 12px 0; opacity: 0.9; color: white;">已完成订单</h3>
            <p class="metric-value" style="font-size: 36px; font-weight: 700; margin: 0; color: white;">{{
                stats.finished_orders }}</p>
        </div>
        <div class="metric-card"
            style="background: #5397f4; border-radius: 12px; padding: 24px; color: white; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); transition: transform 0.3s ease;">
            <h3 style="font-size: 14px; font-weight: 500; margin: 0 0 12px 0; opacity: 0.9; color: white;">总订单数</h3>
            <p class="metric-value" style="font-size: 36px; font-weight: 700; margin: 0; color: white;">{{
                stats.unfinished_orders + stats.finished_orders }}</p>
        </div>
    </div>

    <!-- 任务分配表 -->
    <table border="1" class="table" style="border-collapse: collapse; width: 100%; table-layout: fixed;">
        <thead>
            <tr style="height: 30px;">
                <th>任务 ID</th>
                <th>处方 ID</th>
                <th>当前阶段状态</th>
                <th>收方工人</th>
                <th>配方工人</th>
                <th>煎药工人</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="taskTable">
            {% for task in tasks %}
            <tr class="task-row" style="height: 60px;">
                <td style="text-align: center;">{{ task.task_id }}</td>
                <td style="text-align: center;">{{ task.prescription_id }}</td>
                <td style="text-align: center;">{{ task.phase_status }}</td>
                <td style="text-align: center;">
                    <span class="worker-name
                            {% if task.receive_time %}
                                completed
                            {% elif task.receive_worker_id %}
                                uncompleted
                            {% else %}
                                unassigned
                            {% endif %}">
                        {{ task.receive_worker_name or '未分配' }}
                    </span>
                </td>
                <td style="text-align: center;">
                    <span class="worker-name
                            {% if task.form_time %}
                                completed
                            {% elif task.form_worker_id %}
                                uncompleted
                            {% else %}
                                unassigned
                            {% endif %}">
                        {{ task.form_worker_name or '未分配' }}
                    </span>
                </td>
                <td style="text-align: center;">
                    <span class="worker-name
                            {% if task.decoction_end_time %}
                                completed
                            {% elif task.decoction_worker_id %}
                                uncompleted
                            {% else %}
                                unassigned
                            {% endif %}">
                        {{ task.decoction_worker_name or '未分配' }}
                    </span>
                </td>
                <td style="text-align: center;">
                    {% if task.status != '完成' %}
                    <div
                        style="display: flex; align-items: center; gap: 8px; justify-content: center; flex-wrap: wrap;">
                        <form method="POST" action="{{ url_for('admin.assign_tasks') }}"
                            style="margin: 0; display: flex; gap: 5px; align-items: center;">
                            <input type="hidden" name="task_id" value="{{ task.task_id }}">
                            <input type="hidden" name="operation" value="assign">

                            <select name="task_type"
                                style="width: 90px; height: 28px; font-size: 12px; color: #000000; background-color: #ffffff; border: 1px solid #cbd5e1; border-radius: 4px;"
                                required>
                                <option value="" selected disabled style="color: #666;">选择工序</option>
                                <option value="receive" {% if task.receive_time %}disabled{% endif %}
                                    style="color: #000000;">收方</option>
                                <option value="formulate" {% if task.form_time %}disabled{% endif %}
                                    style="color: #000000;">配方</option>
                                <option value="decoction" {% if task.decoction_end_time %}disabled{% endif %}
                                    style="color: #000000;">煎药</option>
                            </select>
                            <select name="worker_id"
                                style="width: 90px; height: 28px; font-size: 12px; color: #000000; background-color: #ffffff; border: 1px solid #cbd5e1; border-radius: 4px;"
                                required>
                                <option value="" selected disabled style="color: #666;">选择工人</option>
                                {% for worker in workers %}
                                <option value="{{ worker.worker_id }}" style="color: #000000;">{{ worker.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <button type="submit"
                                style="font-size: 12px; padding: 4px 12px; height: 28px; white-space: nowrap;">分配</button>
                        </form>

                        <button class="small-button"
                            style="background-color: #dc2626; color: white; border: none; padding: 4px 12px; cursor: pointer; height: 28px; font-size: 12px; border-radius: 4px;"
                            data-task-id="{{ task.task_id }}"
                            data-receive-completed="{{ 'true' if task.receive_time else 'false' }} "
                            data-form-completed="{{ 'true' if task.form_time else 'false' }}"
                            data-decoction-started="{{ 'true' if task.decoction_start_time else 'false' }}"
                            data-decoction-ended="{{ 'true' if task.decoction_end_time else 'false' }}"
                            onclick="openRollbackModal(this)">回退</button>
                    </div>
                    {% else %}
                    <span>任务已完成</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- 分页 -->
<div class="pagination" id="pagination"></div>

<!-- 回退任务弹窗 -->
<div id="rollbackModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeRollbackModal()">&times;</span>
        <h2>回退任务</h2>
        <form method="POST" action="{{ url_for('admin.assign_tasks') }}">
            <input type="hidden" name="task_id" id="rollbackTaskId">
            <input type="hidden" name="operation" value="rollback">

            <label for="rollback_phase">选择回退阶段:</label>
            <select name="rollback_phase" id="rollback_phase" required>
                <option value="receive">回退到收方前</option>
                <option value="formulate">回退到配方阶段</option>
                <option value="decoction_start">回退到煎药开始</option>
                <option value="decoction_end">回退到煎药结束</option>
            </select>

            <label for="rollback_password">确认密码:</label>
            <input type="password" name="rollback_password" id="rollback_password" required>
            <button type="submit">确认回退</button>
        </form>
    </div>
</div>
{% endblock %}